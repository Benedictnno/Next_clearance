generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("MONGODB_URI")
}

// -----------------------------
// Enums
// -----------------------------
enum Role {
  STUDENT
  OFFICER
  ADMIN
  SUPER_ADMIN
}

enum ClearanceRequestStatus {
  PENDING
  IN_PROGRESS
  REJECTED
  COMPLETED
}

enum StepStatus {
  PENDING
  APPROVED
  REJECTED
  SKIPPED
}

enum DocumentType {
  ID_CARD
  CLEARANCE_FORM
  RECEIPT
  OTHER
}

enum NotificationType {
  INFO
  WARNING
  ACTION_REQUIRED
  SUCCESS
}

// -----------------------------
// User (auth - WITH reverse relations)
// -----------------------------
model User {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  externalId  String?  @unique
  email       String   @unique
  password    String?
  name        String?
  role        Role     @default(STUDENT)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  isDeleted   Boolean  @default(false)
  deletedAt   DateTime?
  
  // Reverse relations
  student       Student?
  officer       Officer?
  admin         Admin?
  notifications Notification[]
  auditLogs     AuditLog[]
  
  @@map("users")
}

// -----------------------------
// Faculty
// -----------------------------
model Faculty {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  name       String   @unique
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  isDeleted  Boolean  @default(false)
  deletedAt  DateTime?

  departments Department[]
  students    Student[]      @relation("StudentFaculty")

  @@map("faculties")
}

// -----------------------------
// Department
// -----------------------------
model Department {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  name          String   @unique
  description   String?
  contactEmail  String?
  contactPhone  String?
  facultyId     String?  @db.ObjectId
  faculty       Faculty? @relation(fields: [facultyId], references: [id])

  // HOD relation (the owning side defines fields/references)
  // FIXED: Added @unique and onDelete/onUpdate to break the cycle
  hodOfficerId  String?  @unique @db.ObjectId
  hodOfficer    Officer? @relation(name: "HOD_OF_DEPARTMENT", fields: [hodOfficerId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  isDeleted     Boolean  @default(false)
  deletedAt     DateTime?

  officers      Officer[] @relation(name: "OFFICERS_IN_DEPARTMENT")
  students      Student[] @relation("StudentDepartment")
  clearanceSteps ClearanceStep[]

  @@map("departments")
}

// -----------------------------
// Student (linked to User; NOW belongs to a department)
// -----------------------------
model Student {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  userId           String   @unique @db.ObjectId
  user             User     @relation(fields: [userId], references: [id])
  matricNumber     String   @unique
  firstName        String?
  lastName         String?
  admissionYear    Int?
  yearsSinceAdmission Int?
  // Faculty and Department relations with named relations
  facultyId        String?  @db.ObjectId
  faculty          Faculty? @relation(name: "StudentFaculty", fields: [facultyId], references: [id])
  departmentId     String?  @db.ObjectId
  department       Department? @relation(name: "StudentDepartment", fields: [departmentId], references: [id])
  
  level            String?
  phoneNumber      String?
  address          String?
  dateOfBirth      DateTime?
  gender           String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  isDeleted        Boolean  @default(false)
  deletedAt        DateTime?

  clearanceRequests ClearanceRequest[]
  studentID         StudentID?
  nyscForm          NYSCForm?
  nyscInfo          NYSCInfo?
  notificationOfResult NotificationOfResult?
  documents         Document[]

  @@map("students")
}

// -----------------------------
// Officer (linked to User; belongs to Department, plus inverse HOD relation)
// -----------------------------
model Officer {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  userId       String   @unique @db.ObjectId
  user         User     @relation(fields: [userId], references: [id])
  name         String?
  departmentId String?  @db.ObjectId
  
  // NEW: Enhanced System Fields
  assignedOffices    String[] // Array of office IDs ["hod", "library", etc.]
  assignedDepartmentId String? // If HOD, which department ID they manage
  assignedDepartmentName String?
  
  // Keep legacy single fields for backward compat if needed, or deprecate
  assignedOfficeId   String? 
  assignedOfficeName String? 

  // This is the Officer -> Department relation (owning side)
  department   Department? @relation(name: "OFFICERS_IN_DEPARTMENT", fields: [departmentId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // This is the inverse side of Department.hodOfficer (no fields/references here)
  hodDepartment Department? @relation(name: "HOD_OF_DEPARTMENT")

  role         String?  // e.g., "HOD", "DEAN", "FACULTY_OFFICER"
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  isDeleted    Boolean  @default(false)
  deletedAt    DateTime?

  approvals    ClearanceProgress[]
  assignedSteps ClearanceStep[] @relation(name: "ASSIGNED_TO_STEP")

  @@map("officers")
}

// -----------------------------
// Admin (linked to User)
// -----------------------------
model Admin {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @unique @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  isDeleted Boolean  @default(false)
  deletedAt DateTime?

  @@map("admins")
}

// -----------------------------
// ClearanceStep (template - optional department association)
// -----------------------------
model ClearanceStep {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  stepNumber      Int
  name            String
  description     String?
  
  // NEW: isDepartmentSpecific flag
  isDepartmentSpecific Boolean @default(false) // true for HOD, false for others
  
  departmentId    String?  @db.ObjectId
  department      Department? @relation(fields: [departmentId], references: [id])
  
  // NEW: For university-wide steps, assign a specific officer
  assignedOfficerId String? @db.ObjectId
  assignedOfficer   Officer? @relation(name: "ASSIGNED_TO_STEP", fields: [assignedOfficerId], references: [id])
  
  requiresPayment Boolean  @default(false)
  paymentAmount   Float?
  
  // Document requirements for this step
  requiredDocuments Json? // Array of required document types
  requiresReceipt   Boolean @default(false)
  receiptDescription String? // e.g., "Payment receipt for clearance fee"
  supportingDocsDescription String? // e.g., "Upload library clearance form"
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  isDeleted       Boolean  @default(false)
  deletedAt       DateTime?

  clearanceProgress ClearanceProgress[]

  @@map("clearance_steps")
}

// -----------------------------
// ClearanceRequest (instance per student)
// -----------------------------
model ClearanceRequest {
  id            String                 @id @default(auto()) @map("_id") @db.ObjectId
  studentId     String                 @db.ObjectId
  student       Student                @relation(fields: [studentId], references: [id])
  status        ClearanceRequestStatus @default(PENDING)
  currentStep   Int                    @default(1)
  startedAt     DateTime               @default(now())
  completedAt   DateTime?
  finalPdfUrl   String?
  nyscAccessed  Boolean                @default(false)
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt
  isDeleted     Boolean                @default(false)
  deletedAt     DateTime?

  steps         ClearanceProgress[]
  documents     Document[]            // request-level documents (optional)
  notifications Notification[]

  @@map("clearance_requests")
}

// -----------------------------
// ClearanceProgress (Effective ClearanceSubmission)
// -----------------------------
model ClearanceProgress {
  id                 String           @id @default(auto()) @map("_id") @db.ObjectId
  
  // Critical for Two-Tier Logic
  submissionKey      String           // "hod-{deptId}" or "{officeId}"
  
  requestId          String           @db.ObjectId
  request            ClearanceRequest @relation(fields: [requestId], references: [id])
  
  // Optional link to step if we keep using ClearanceStep model, otherwise relying on hardcoded config
  stepId             String?          @db.ObjectId
  step               ClearanceStep?   @relation(fields: [stepId], references: [id])
  
  // Flattened fields for easy access/filtering
  officeId           String           // "hod", "library", etc.
  officeName         String
  isDepartmentSpecific Boolean
  studentDepartment  String?          // Snapshot for HOD filtering
  
  stepNumber         Int
  status             StepStatus       @default(PENDING)
  
  officerId          String?          @db.ObjectId
  officer            Officer?         @relation(fields: [officerId], references: [id])
  
  comment            String?
  actionedAt         DateTime?
  
  reviewedBy         String?          // ID of reviewer
  
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  isDeleted          Boolean          @default(false)
  deletedAt          DateTime?

  documents          Document[]
  
  @@unique([requestId, submissionKey]) // Ensure one submission per office per request
  @@index([submissionKey])
  @@index([status])

  @@map("clearances")
}

// -----------------------------
// Document (Cloudinary metadata)
// can link to student-level, request-level, or step-level
// -----------------------------
model Document {
  id                  String   @id @default(auto()) @map("_id") @db.ObjectId
  studentId           String?  @db.ObjectId
  student             Student? @relation(fields: [studentId], references: [id])
  requestId           String?  @db.ObjectId
  request             ClearanceRequest? @relation(fields: [requestId], references: [id])
  clearanceProgressId String?  @db.ObjectId
  clearanceProgress   ClearanceProgress? @relation(fields: [clearanceProgressId], references: [id])

  fileName            String
  fileSize            Int
  mimeType            String
  documentType        DocumentType
  cloudinaryPublicId  String
  cloudinaryUrl       String
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  isDeleted           Boolean  @default(false)
  deletedAt           DateTime?

  @@map("documents")
}

// -----------------------------
// StudentID (card)
// -----------------------------
model StudentID {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  studentId  String   @unique @db.ObjectId
  student    Student  @relation(fields: [studentId], references: [id])
  cardNumber String   @unique
  qrCode     String?
  imageUrl   String?
  issuedDate DateTime @default(now())
  expiryDate DateTime?
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  isDeleted  Boolean  @default(false)
  deletedAt  DateTime?

  @@map("student_id_cards")
}

// -----------------------------
// NYSC Form
// -----------------------------
model NYSCForm {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  studentId     String   @unique @db.ObjectId
  student       Student  @relation(fields: [studentId], references: [id])
  formNumber    String   @unique
  formUrl       String
  generatedDate DateTime @default(now())
  status        String   @default("generated")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  isDeleted     Boolean  @default(false)
  deletedAt     DateTime?

  @@map("nysc_forms")
}

// -----------------------------
// NYSC Info (student information for NYSC mobilization)
// -----------------------------
model NYSCInfo {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  studentId         String   @unique @db.ObjectId
  student           Student  @relation(fields: [studentId], references: [id])
  name              String
  faculty           String
  department        String
  courseOfStudy     String
  matricNumber      String
  jambRegNo         String?
  sex               String
  dateOfBirthDay    String
  dateOfBirthMonth  String
  dateOfBirthYear   String
  maritalStatus     String
  stateOfOrigin     String
  lgaOfOrigin       String
  dateOfGraduation  String?
  phoneNumber       String
  email             String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("nysc_info")
}

// -----------------------------
// Notification
// -----------------------------
model Notification {
  id         String           @id @default(auto()) @map("_id") @db.ObjectId
  userId     String           @db.ObjectId
  user       User             @relation(fields: [userId], references: [id])
  requestId  String?          @db.ObjectId
  request    ClearanceRequest? @relation(fields: [requestId], references: [id])
  title      String
  message    String
  isRead     Boolean          @default(false)
  type       NotificationType @default(INFO)
  payload    Json?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  @@map("notifications")
}

// -----------------------------
// Audit Log
// -----------------------------
model AuditLog {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String?  @db.ObjectId
  user      User?    @relation(fields: [userId], references: [id])
  action    String
  meta      Json?
  createdAt DateTime @default(now())

  @@map("audit_logs")
}

// -----------------------------
// Notification of Result Form
// -----------------------------
model NotificationOfResult {
  id               String   @id @default(auto()) @map("_id") @db.ObjectId
  studentId        String   @unique @db.ObjectId
  student          Student  @relation(fields: [studentId], references: [id])
  formNumber       String   @unique
  formUrl          String
  generatedDate    DateTime @default(now())
  status           String   @default("generated")
  
  // Form data
  name             String
  faculty          String
  department       String
  matricNumber     String
  courseOfStudy    String
  graduationYear   String
  cgpa             String?
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  isDeleted        Boolean  @default(false)
  deletedAt        DateTime?
}